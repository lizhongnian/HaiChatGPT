<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 9.6.6 (470456)"/><meta name="altitude" content="7.117198944091797"/><meta name="author" content="drivener@163.com"/><meta name="created" content="2021-01-12 04:57:16 +0000"/><meta name="latitude" content="31.1662979980213"/><meta name="longitude" content="121.2884645506771"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2023-04-08 08:42:30 +0000"/><title>docker学习笔记</title></head><body style="font-size: 14px;"><div/><div><font style="font-size: 18px;"><b>Docker笔记</b></font></div><div><span><br/></span></div><div><a href="https://www.runoob.com/docker/docker-tutorial.html">https://www.runoob.com/docker/docker-tutorial.html</a></div><div>Docker 是一个开源的应用容器引擎，基于 Go 语言 并遵从 Apache2.0 协议开源。</div><div>Docker 可以让开发者打包他们的应用以及依赖包到一个轻量级、可移植的容器中，然后发布到任何流行的 Linux 机器上，也可以实现虚拟化。</div><div>docker的基本概念：</div><div>镜像（Image）：相当于一个root系统</div><div>容器（Container）：镜像和容器就像类和实例，镜像是静态定义，而容器是镜像运行的实体。容器可以创建、启动、停止、删除和暂停。</div><div>仓库（Repository）：代码控制中心，用来保存镜像的。</div><div><br/></div><div>使用客户端-服务器（C-S）模式，使用远程API来管理和创建Docker容器。</div><div>主机：一个物理或者虚拟的机器用于执行Docker的守护进程和容器</div><div>客户端：通过命令行或其他工具使用SDK与主机通信。</div><div><br/></div><div>docker hub: <a href="https://hub.docker.com/">https://hub.docker.com</a></div><div><br/></div><div>一、安装docker</div><div>是指安装Docker Engine-Community </div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>sudo curl -sSL https://get.daocloud.io/docker | sh  # ubuntu 自动安装</div><div>curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun  # 自动安装，更块</div><div>sudo usermod -aG docker zzd  # 不使用root而是使用zzd来运行docker</div><div>docker --version  # 验证是否安装成功</div></div><div><br/></div><div># 权限问题</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>sudo groupadd docker</div><div>sudo gpasswd -a $USER docker </div><div>newgrp docker</div><div>id $USER</div></div><div><br/></div><div>二、设置镜像加速</div><div>查询阿里云镜像加速的专属地址。</div><div><a href="https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors?spm=5176.12901015.0.i12901015.17f7525cjCFOkP">https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors?spm=5176.12901015.0.i12901015.17f7525cjCFOkP</a></div><div><br/></div><div>use_mine：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>https://xxxxx.mirror.aliyuncs.com</div><div><br/></div><div># 更新源</div><div>sudo vi /etc/docker/daemon.json</div><div># 添加如下内容：</div><div>{</div><div>   "registry-mirrors": [</div><div>       "http://hub-mirror.c.163.com",</div><div>       "https://registry.docker-cn.com",</div><div>       "https://docker.mirrors.ustc.edu.cn",</div><div>       "https://xxxxx.mirror.aliyuncs.com",</div><div>       "https://xxxxx.mirror.aliyuncs.com"]</div><div>}</div><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></span></div><div>sudo systemctl daemon-reload</div><div>sudo systemctl restart docker</div><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">docker info  # 查看源是否更新了</span></div></div><div><br/></div><div>三、hello word</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div># 从镜像启动容器</div><div>sudo docker run ubuntu:latest /bin/echo "Hello world"</div></div><div>镜像15.10如果本地存在就启动，不存在会拉取再启动。</div><div>后面是指定命令/bin/echo "Hello world"</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div># 交互式启动</div><div>sudo docker run -i -t ubuntu:15.10 /bin/bash</div><div># -i 允许标准输入 -t 指定一个终端或伪终端</div><div>exit  # 退出容器</div></div><div><br/></div><div>后台运行容器</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">sudo </span>docker run -d ubuntu:15.10 /bin/sh -c "while true; do echo hello world; sleep 1; done"</div><div>docker ps  # 查看正在运行的容器</div><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"># 输出如下：</span></div><div>CONTAINER ID   IMAGE          COMMAND                  CREATED         STATUS         PORTS     NAMES</div><div>eb65e098d53c   ubuntu:15.10   "/bin/sh -c 'while t…"   5 minutes ago   Up 5 minutes             lucid_yonath</div><div># 该容器的名字是lucid_yonath</div><div>docker logs lucid_yonath  # 查看容器的标准输出是什么</div><div>docker logs eb65e098d53  # 或者这个</div><div>docker stop eb65e098d53  # 停止容器</div></div><div><br/></div><div>四、docker 运行web应用</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>docker pull training/webapp  # 载入镜像</div><div>docker run -d -P training/webapp python app.py </div><div>docker ps  # 查看，发现0.0.0.0:49153-&gt;5000/tcp，开放了python flask默认5000端口映射到主机的49153端口。</div><div># 浏览器输入ip地址:49153就可以了访问web应用了</div><div># 也可以运行时指定端口映射</div><div>docker run -d -p 5000:5000 training/webapp python app.py</div></div><div><br/></div><div><br/></div><div>命令：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>docker  # 查看所有命名</div><div>docker command --help  # 查看该命令具体用法</div><div>docker run -it ubuntu /bin/bash  # 交互式启动</div><div>docker ps -a  # 查看所有容器</div><div>docker start id  # 启动已停止的容器，id是刚刚查询的容器id</div><div>docker run -itd --name ubuntu-test ubuntu /bin/bash  # 后台运行，同时指定名字</div><div>docker stop id  # 停止容器</div><div>docker restart id  # 重启容器</div><div>docker attach id  # 对于后台启动的容器，进入</div><div>docker exec  # 退出容器但保持后台运行</div><div><br/></div><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"># 导出容器快照</span></div><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">docker export id &gt; ubuntu.tar</span></div><div>cat docker/ubuntu.tar | docker import - test/ubuntu:v1  # 把刚刚保存的快照导入到test/ubuntu:v1镜像中。</div><div>docker import http://example.com/exampleimage.tgz example/imagerepo  # 指定url和镜像导入</div><div>docker rm -f id  # 删除容器</div><div>docker container prune  # 删除已停止的容器</div><div><br/></div><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"># 容器运行状态</span></div><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">docker port id  # </span>查看容器端口映射</div><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">docker logs id  # 查看容器输出，加-f能一直查看</span></div><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">docker top id  # 查看容器进程</span></div><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">docker inspect id  # 查看容器低层信息</span></div><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"><br/></span></div><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"># 关于镜像</span></div><div>docker images  # 本地存在的镜像</div><div>docker pull ubuntu  # 拉取镜像</div><div>docker rmi &lt;id&gt;</div></div><div><br/></div><div>运行docker</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>docker run --gpus all -it --rm -v $(pwd)/yolov4-triton-tensorrt:/yolov4-triton-tensorrt nvcr.io/nvidia/tensorrt:20.08-py3</div><div><br/></div><div><font face="Monaco">—gpus all: 把所有GPU添加到容器中</font></div><div><font face="Monaco">-it: 标准输入和tty</font></div><div><font face="Monaco">--rm: 如果容器存在，自动删除</font></div><div><font face="Monaco">-v：绑定mount一个卷,把主机的xxx目录挂在到容器的xxx目录</font></div><div><font face="Monaco"><br/></font></div></div><div><br/></div><div><br/></div><div>五、docker使用</div><div>从docker hub拉取镜像，如ubuntu: <a href="https://hub.docker.com/_/ubuntu?tab=tags">https://hub.docker.com/_/ubuntu?tab=tags</a></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div># 查询到拉取ubuntu1804的命令为：</div><div>docker pull ubuntu:18.04</div><div><br/></div><div># 运行</div><div>docker run -it --net=host \</div><div>-v /Users/xxx/software:/root/software \</div><div>-v /Users/xxx/PycharmProjects:/root/PycharmProject \</div><div>--name ubuntu_triton \</div><div>ubuntu:18.04</div><div><br/></div><div># 修改容器后，导出并覆盖容器</div><div><font face="Monaco">Docker commit &lt;id&gt; ubuntu_triton</font></div><div><font face="Monaco"><br/></font></div></div><div><br/></div><div>挂在摄像头：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div># docker run的时候设置</div><div>--device=/dev/video0</div></div><div><br/></div><div>主机Mac，在docker上显示图像：<a href="https://www.cnblogs.com/noluye/p/11405358.html">https://www.cnblogs.com/noluye/p/11405358.html</a></div><div>使用socat</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>brew install socat</div><div>brew install xquartz</div><div># 查询</div><div>echo $DISPLAY  # 重启系统，如果想有显示就说明主机有了</div><div># 主机上运行服务</div><div>socat TCP-LISTEN:6000,reuseaddr,fork UNIX-CLIENT:\"$DISPLAY\”  # 不能断</div><div><br/></div><div># 查询macos 地址</div><div><font face="Monaco">ifconfig en0  # 192.168.0.64</font></div><div><font face="Monaco"># 方法1，容器内：</font></div><div>export DISPLAY=192.168.0.64:0</div><div># 方法2，启动容器时添加：</div><div># -e DISPLAY=192.168.0.64:0 </div></div><div><br/></div><div><br/></div><div>六.总结</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div># 远程服务器启动docker作为服务端</div><div><font face="Monaco">cd workplace</font></div><div>./start_triton.sh</div><div><br/></div><div># 本地启动显示</div><div>socat TCP-LISTEN:6000,reuseaddr,fork UNIX-CLIENT:\"$DISPLAY\"</div><div><br/></div><div># 本地启动docker作为客户端</div><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">cd ~/</span>sjtu2020/triton_client</div><div>./start_ubuntu18042.sh</div><div>cd /root/PycharmProject/TensorRT/yolov4_triton_tensorrt/clients/python</div><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">cctr</span></div><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">python clinet2.py image data/dog.jpg</span></div><div>python client_video.py</div></div><div><br/></div><div>启动tf1.15容器</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>docker run --gpus all -it —rm --name tf115 tensorflow/tensorflow:1.15.5-gpu</div></div><div><br/></div><div># 从image创建容器</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>docker run --gpus all -itd --name tf \</div><div>-v /home/zzd/PycharmProject:/root/PycharmProject \</div><div>tensorflow/tensorflow:1.15.5-gpu  # 这里是image，输入是image的名字:TAG</div></div><div># 查询容器</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>docker ps -a  # 容器别名是tf115</div></div><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"># 进入容器</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>docker start tf115  # 启动容器</div><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">docker stop tf115  # 停止容器</span></div><div>docker attach tf115  # 对运行中的容器，进入到容器内，输入exit后，容器自动停止</div><div>docker exec -it tf115 /bin/bash /root/xxx.sh  # 对运行中的容器，进入到容器内，输入exit后容器不会停止，进入的同时运行/root/xxx.sh脚本</div><div># 写成了dktf.sh的，简码：</div><div>dktf</div></div><div># 重新挂载路径</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"># 先把容器保存为镜像</span></div><div>docker commit -a 'zzd' -m 'zzd tf115' tf115 zzdtf115:v1  # 保存的镜像直接就在images里了</div><div>docker images  # 查看保存的镜像，仓库是zzdtf115 TAG是v1</div><div># 重新启动</div><div>docker run --gpus all -itd --name tf115 \</div><div>-v /home/zzd/PycharmProject:/home/zzd/PycharmProject \</div><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">zzdtf115:v1</span></div></div><div><br/></div><div># 新开一个容器用户</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>docker run --gpus all -it --name zjm --privileged=true \</div><div>nvcr.io/nvidia/pytorch:21.08-py3 /sbin/init </div><div><br/></div><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"># </span>--privileged=true一定要写，否则无法启用systemctl和ssh服务</div><div># /sbin/init必须从这里进入</div></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></body></html>